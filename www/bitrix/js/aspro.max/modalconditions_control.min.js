function initAsproMaxModalConditionsControl(o){var t=JSON.parse(o.data);t&&(window["aspro_max_modalconditions_conditions_"+o.propertyID]=new AsproMaxModalConditionsControl(t,o))}function AsproMaxModalConditionsControl(o,t){var i=BX.util.getRandomString(5),a=this;this.params=t||{},this.message=JSON.parse(t.propertyParams.JS_MESSAGES)||{},this.data=o||{},this.nodes={},this.ids={form:"limit_cond_form_"+this.params.propertyID+"_"+i,container:"limit_cond_container_"+this.params.propertyID+"_"+i,treeObject:"limit_cond_obj_"+this.params.propertyID+"_"+i},this.path=this.getPath(),this.buildNodes(),BX.addCustomEvent("onTreeConditionsInit",BX.proxy(this.modifyTreeParams,this)),BX.addCustomEvent("onAdminTabsDeleteLevel",BX.proxy(this.onChangeForm,this)),BX.addCustomEvent("onMaxVisualChange",BX.proxy(this.onChangeForm,this)),BX.addCustomEvent("onTreeCondPopupClose",BX.proxy(this.onChangeForm,this)),BX.addCustomEvent("onTreeCondDialogSave",BX.proxy(function(o){var t=this;setTimeout(function(){t.onChangeForm()},100)},this)),BX.loadScript("/bitrix/js/catalog/core_tree.js",function(){BX.ajax({timeout:60,method:"POST",dataType:"html",url:a.path,data:{action:"init",data:a.data,property:{id:a.params.propertyParams.ID,iblockId:a.params.propertyParams.IBLOCK_ID},condition:a.params.oInput.value,ids:a.ids,sessid:BX.bitrix_sessid()},onsuccess:BX.proxy(this.saveData,this)})}),BX.loadCSS("/bitrix/panel/catalog/catalog_cond.css")}AsproMaxModalConditionsControl.prototype={getPath:function(){return this.params.propertyParams.AJAX_FILE},deleteFromArray:function(o,t){if(BX.type.isArray(o)&&BX.type.isArray(t))for(var i=t.length;--i;)t[i]&&t.hasOwnProperty(i)&&BX.util.in_array(i,o)&&t.splice(i,1)},onChangeForm:function(){this.nodes.form&&BX.fireEvent(this.nodes.form,"change")},modifyTreeParams:function(o,t,i){if(i&&o.formName===this.ids.form){var a,s,r=[];for(a in i)i.hasOwnProperty(a)&&((s=i[a]).group?this.modifyCondGroup(s):this.modifyCondValueGroup(s)&&r.push(a));this.deleteFromArray(r,i)}},modifyCondGroup:function(o){var t;if(o.visual)for(t in o.visual.values)o.visual.values.hasOwnProperty(t)&&"False"===o.visual.values[t].True&&(o.visual.values.splice(t,1),o.visual.logic.splice(t,1));if(o.control)for(t in o.control)o.control.hasOwnProperty(t)&&(o.control[t].dontShowFirstOption=!0,"True"===o.control[t].id&&delete o.control[t].values.False)},modifyCondValueGroup:function(o){if(o&&o.children&&o.children.length){var t,i,a,s=["CondPage"];for(var r in o.children)if(o.children.hasOwnProperty(r)){if(i=o.children[r],t=!0,BX.util.in_array(i.controlId,s))t=!1;else{if((a=i.controlId.split(":"))[1]&&a[1]!=this.data.iblockId&&a[1]!=this.data.offersIblockId)return!0;"CondIBProp"!==a[0]&&"CondCrossIBProp"!==a[0]||!a[2]||(t=!1)}t&&delete o.children[r]}return o.children=o.children.filter(function(o){return o}),!1}},buildNodes:function(){this.nodes.warning=BX.create("DIV",{props:{className:"bx-filter-conditions-warning dm-info-message-wrap adm-info-message-red"},html:'<div class="adm-info-message"><div class="adm-info-message-title">'+this.message.invalid+'</div><div class="adm-info-message-icon"></div></div>',style:{display:"none"}}),this.nodes.container=BX.create("DIV",{props:{id:this.ids.container}}),this.nodes.form=BX.create("FORM",{props:{id:this.ids.form,name:this.ids.form},children:[this.nodes.container],events:{change:BX.proxy(function(){this.saveData()},this)}}),this.params.oCont.appendChild(BX.create("DIV",{children:[this.nodes.warning,this.nodes.form]})),BX.bindDelegate(this.nodes.form,"mousedown",{className:"condition-item-del"},BX.proxy(function(){var o=this;setTimeout(function(){o.onChangeForm()},100)},this))},saveData:function(){var o={action:"save",ids:this.ids,data:this.data,property:{id:this.params.propertyParams.ID,iblockId:this.params.propertyParams.IBLOCK_ID},sessid:BX.bitrix_sessid()};BX.ajax({timeout:60,method:"POST",dataType:"json",url:this.path,data:BX.merge(this.getAllFormData(),o),onsuccess:BX.proxy(function(o){""===o?this.nodes.warning.style.display="block":(this.nodes.warning.style.display="none",this.params.oInput.value=JSON.stringify(o))},this)})},getAllFormData:function(){var o=BX.ajax.prepareForm(this.nodes.form);for(var t in o.data)o.data.hasOwnProperty(t)&&""==t&&delete o.data[t];return o&&o.data?o.data:{}}};